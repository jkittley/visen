{% extends "base.html" %}
{% load i18n %}

{% block title %}
{{ site.name }}
{% endblock %}

{% block head %}
<script type="text/javascript" src="/media/frontend/js/d3.min.js"></script>
<script src="/media/frontend/js/highchart/highcharts.js"></script>
<link rel="stylesheet" href="/media/frontend/css/cal.css"/>
<style>
.cluster_patterns { 

}
.cal_main { 
    margin-left:10px;
    width: 100vw;
    position: absolute;
}
.cal_year_title {
    margin-left:30px;
}
.cal_year_group {
    position: relative;
    height:800px;
}
.cal_frame { 
     width: 200px;
     position: absolute;
}
#colorlegend { 
     margin-top: 10px;
}
.progress { 
    margin-bottom:0px;
    padding-bottom: 0px;
}
.day-title { 
    font-size: 10px;
    padding-left:5px;
}
.chart_patterns{ 
    width:700px;
    height:600px;
    float:right;
}
</style>
{% endblock %}


{% block menuextras %}
    <li><a href="{% url edit vis.pk %}"><i class="fa fa-pencil"></i> Edit</a></li>
    <li><a href="{% url clear_cache vis.pk %}"><i class="fa fa-refresh"></i> Refresh</a></li>
{% endblock %}

{% block content %}
{% load staticfiles %}
<h3><p class="text-center">{{ vis.name }} ({{ vis.group }})</p></h3>
<p class="text-center lead">{{ s_date }} to {{ e_date }}</p>
{% if data != 'null' %}
</div>

<div id="chart" class="chart_patterns"></div>
<div id="calendar" class="cal_main">
<script>
    
    var weekday = new Array(7);
        weekday[0]=  "Sunday";
        weekday[1] = "Monday";
        weekday[2] = "Tuesday";
        weekday[3] = "Wednesday";
        weekday[4] = "Thursday";
        weekday[5] = "Friday";
        weekday[6] = "Saturday";

    var width               = 500,
        height              = 800,
        cellSize            = 20;
    var no_months_in_a_row  = 3;
    var shift_up            = cellSize * 3;
    var day                 = d3.time.format("%w"), // day of the week
        day_of_month        = d3.time.format("%e")  // day of the month
        day_of_year         = d3.time.format("%j")  // day of the year
        week                = d3.time.format("%U"), // week number of the year
        month               = d3.time.format("%m"), // month number
        year                = d3.time.format("%Y"), 
        percent             = d3.format(".1%"),
        format              = d3.time.format("%Y-%m-%d");

    //  Tooltip Object
    var tooltip = d3.select("body")
        .append("div").attr("id", "tooltip")
        .style("position", "absolute")
        .style("z-index", "10")
        .style("visibility", "hidden")
        .text("a simple tooltip");

    var rdata = {{ data|safe }};
    var range = (rdata.highest - rdata.lowest) / 100;
    var base  = rdata.lowest



    // Add warning messages for channels with no data
    if (rdata.messages && rdata.messages.length>0) 
        for (var i=0; i<rdata.messages.length; i++) {  addMessage(rdata.messages[i], 0); }

    // Reading value to colour converter
    // var color = d3.scale.ordinal()
    //     .domain(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15)
    //     .range(["#e2431e","#e7711b","#f1ca3a","#6f9654","#1c91c0",'#43459d','#4572A7', '#AA4643', '#89A54E', '#80699B', '#3D96AE', '#DB843D', '#92A8CD', '#A47D7C', '#B5CA92']);

    // Reading value to colour converter
    var color = d3.scale.category10();
       



    // For each yeat to be displated
    for (var myyear=rdata.earliest_year; myyear <= rdata.most_recent_year; myyear++) {
        var xpos = 20;
        $( '#calendar' ).append('<div id="year_group_'+myyear+'" class="cal_year_group"></div>');       
        for (var i=0; i<rdata.sets.length; i++) { 
            build_cal('#year_group_'+myyear, rdata.sets[i], myyear, xpos, 'c_'+myyear+'_'+i);
            xpos += width;
        }
    }
    

    function build_cal(container, ldata, display_year, xpos, ref) {
     
        $( container ).append('<div id="cal_'+ref+'" class="cal_frame"></div>');

        $('#cal_'+ref).css('left', xpos);

            // Build SVG for each year to be displayes
            var svg = d3.select('#cal_'+ref)
                .selectAll("svg")
                .data(d3.range(display_year, display_year+1))   // Range of years to show
                .enter().append("svg")                          // Add an svg for each year
                .attr("width", width)
                .attr("height", height)
                .attr("class", "RdYlGn")
                .append("g")                                   

            // Build days into a month looking form
            var rect = svg.selectAll(".day")
                .data(function(d) { return d3.time.days(new Date(d, 0, 1), new Date(d + 1, 0, 1)); })
                .enter().append("rect")
                .attr("class", "day")
                .attr("fill", function(d) { 
                    if (ldata.daytotals[format(d)]) return color(ldata.daytotals[format(d)]) 
                    else                            return "#eeeeee"; })
                .attr("width", cellSize)
                .attr("height", cellSize)
                .attr("x", function(d) {
                    var month_padding = 1.2 * cellSize*7 * ((month(d)-1) % (no_months_in_a_row));
                    return day(d) * cellSize + month_padding; })
                .attr("y", function(d) { 
                    var week_diff = week(d) - week(new Date(year(d), month(d)-1, 1) );
                    var row_level = Math.ceil(month(d) / (no_months_in_a_row));
                    return (week_diff*cellSize) + row_level*cellSize*8 - cellSize/2 - shift_up; })
                .datum(format);

            // Add titles to months
            var month_titles = svg.selectAll(".month-title")  // Jan, Feb, Mar and the whatnot
                .data(function(d) {  return d3.time.months(new Date(d, 0, 1), new Date(d + 1, 0, 1)); })
                .enter().append("text")
                .text(monthTitle)
                .attr("x", function(d, i) {
                    var month_padding = 1.2 * cellSize*7* ((month(d)-1) % (no_months_in_a_row));
                    return month_padding; })
                .attr("y", function(d, i) {
                    var week_diff = week(d) - week(new Date(year(d), month(d)-1, 1) );
                    var row_level = Math.ceil(month(d) / (no_months_in_a_row));
                    return (week_diff*cellSize) + row_level*cellSize*8 - cellSize - shift_up - 10; })
                .attr("class", "month-title")
                .attr("d", monthTitle);

            // Add titles to days
            var day_titles = svg.selectAll(".day-title")  
                .data(function(d) {  return d3.time.months(new Date(d, 0, 1), new Date(d + 1, 0, 1)); })
                .enter().append("text")
                .text('-S -- M -- T -- W -- T -- F -- S-')
                .attr("x", function(d, i) {
                    var month_padding = 1.2 * cellSize*7* ((month(d)-1) % (no_months_in_a_row));
                    return month_padding; })
                .attr("y", function(d, i) {
                    var week_diff = week(d) - week(new Date(year(d), month(d)-1, 1) );
                    var row_level = Math.ceil(month(d) / (no_months_in_a_row));
                    return (week_diff*cellSize) + row_level*cellSize*8 - cellSize - shift_up + 5; })
                .attr("class", "day-title")
                .attr("d", monthTitle);

            var year_titles = svg.selectAll(".year-title")  
                  .data(function(d) { 
                    return d3.time.years(new Date(d, 0, 1), new Date(d + 1, 0, 1)); })
                .enter().append("text")
                  .text(trunc(ldata.showname,25))
                  .style("font-size", "12px")
                  .attr("x", 0)
                  .attr("y", function(d, i) { return cellSize*5.5 - shift_up; })
                  .attr("class", "year-title")
                  .attr("d", yearTitle);

            //  Tooltip
            rect.on("mouseover", mouseover);
            rect.on("mouseout", mouseout);
            function mouseover(d) {
                    tooltip.style("visibility", "visible");
                    tooltip.transition()        
                           .duration(100)      
                           .style("opacity", 1);      
                    tooltip.html(tooltip_text(d,ldata))  
                           .style("left", (d3.event.pageX)+30 + "px")     
                           .style("top", (d3.event.pageY) + "px"); 
            }
                
            function mouseout (d) {
                    tooltip.transition()        
                    .style("opacity", 0); 
            }
        }
    

    function dayTitle (t0) {    return t0.toString().split(" ")[2];  }
    function monthTitle (t0) {  return t0.toLocaleString("en-us", { month: "long" }); }
    function yearTitle (t0) {   return t0.toString().split(" ")[3];  }

    function tooltip_text(d, ldata) {

        var per  = Math.floor( ((ldata.daytotals[d]-base) / range) );
        var date = new Date(d);

        var html = d + " "+weekday[date.getDay()]+'<BR>';
        html += 'Cluster: '+ldata.daytotals[d] + "<BR>";
        return html
    }

    function trunc(str, len) {   
         if (str.length<len) return str;
         return str.substr(0,len-1)+'...';
      };

    var config;
    $( document).ready(function () {
        config = {
        title: {
            text: 'Cluster Patterns',
            x: -20 //center
        },
        xAxis: {
            categories: rdata.patterns.cats
        },
        yAxis: {
            title: {
                text: 'Cluster reading average'
            },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {
            valueSuffix: ' Average  Day KWh'
        },
        legend: {
            layout: 'vertical',
            align: 'right',
            verticalAlign: 'middle',
            borderWidth: 0
        },
        series: rdata.patterns.data
    };

    for (var i=0; i<config.series.length; i++) {
        console.log(config.series.cluster_count)
        console.log(color(config.series[i].cluster_count))
        
        config.series[i].color = color(config.series[i].cluster_count);
    }

    $('#chart').highcharts(config);
});
</script>
{% else %}
Unable to process at this time
{% endif %}
{% endblock %}